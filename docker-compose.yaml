# ==============================================================================
# Switchyard — Docker Compose (Production / Self-hosted)
# ==============================================================================
# Usage:
#   cp configs/.env.example .env   # Fill in your secrets
#   docker compose up -d
#   curl http://localhost:8081/healthz
# ==============================================================================

services:
  switchyard:
    build:
      context: .
      dockerfile: build/Dockerfile
      args:
        VERSION: "${VERSION:-latest}"
    image: switchyard:latest
    container_name: switchyard
    restart: unless-stopped
    ports:
      - "8080:8080"   # HTTP transport
      - "8081:8081"   # Health check
      - "50051:50051" # gRPC transport
    env_file:
      - .env
    volumes:
      - ./configs/switchyard.yaml:/etc/switchyard/switchyard.yaml:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s

  # ---------------------------------------------------------------------------
  # Optional: Piper TTS — per-language containers (enable via profiles)
  # Usage: docker compose --profile tts up -d
  # ---------------------------------------------------------------------------
  piper-en:
    image: lscr.io/linuxserver/piper:latest
    container_name: switchyard-piper-en
    profiles:
      - tts
    restart: unless-stopped
    ports:
      - "10200:10200"
    environment:
      - PIPER_VOICE=en_US-lessac-medium
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - piper-en-data:/config

  piper-fr:
    image: lscr.io/linuxserver/piper:latest
    container_name: switchyard-piper-fr
    profiles:
      - tts
    restart: unless-stopped
    ports:
      - "10201:10200"
    environment:
      - PIPER_VOICE=fr_FR-siwis-medium
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
    volumes:
      - piper-fr-data:/config

  # ---------------------------------------------------------------------------
  # Optional: Mosquitto MQTT broker (enable via profiles)
  # Usage: docker compose --profile mqtt up -d
  # ---------------------------------------------------------------------------
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: switchyard-mqtt
    profiles:
      - mqtt
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - mosquitto-data:/mosquitto/data
      - mosquitto-logs:/mosquitto/log

volumes:
  piper-en-data:
  piper-fr-data:
  mosquitto-data:
  mosquitto-logs:
